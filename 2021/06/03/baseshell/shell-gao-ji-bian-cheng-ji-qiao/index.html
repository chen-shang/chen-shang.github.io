<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Shell高级编程技巧, IT,技术,总结">
    <meta name="description" content="涵盖重定向、进程通信、并发控制、锁、单元测试、调试技巧等高级编程技巧">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Shell高级编程技巧 | 涓涓细流</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="涓涓细流" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">涓涓细流</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">涓涓细流</div>
        <div class="logo-desc">
            
            无限可能
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Shell高级编程技巧</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%8E%9F%E5%88%9B/">
                                <span class="chip bg-color">原创</span>
                            </a>
                        
                            <a href="/tags/%E6%9C%AA%E5%AE%8C%E5%BE%85%E7%BB%AD/">
                                <span class="chip bg-color">未完待续</span>
                            </a>
                        
                            <a href="/tags/Linux/">
                                <span class="chip bg-color">Linux</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/BaseShell/" class="post-category">
                                BaseShell
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-06-03
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-04-09
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    6.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    24 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>一、Shell重定向</h1>
<h2 id="介绍">介绍</h2>
<p>就像我们平时写的程序一样，一段程序会处理外部的输入，然后将运算结果输出到指定的位置。在交互式的程序中，输入来自用户的键盘和鼠标，结果输出到用户的屏幕，甚至播放设备中。shell脚本也一样，但是我们一般在使用shell命令的时候，更多地还是通过键盘输入，然后在屏幕上查看命令的执行结果。如果某些情况下，我们需要将shell命令的执行结果存储到文件中，那么我们就需要使用输入输出的重定向功能。</p>
<h2 id="文件描述符">文件描述符</h2>
<p>当执行shell命令时，会默认打开3个文件，每个打开文件都有对应的文件描述符来方便我们使用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">chenshang@chenshangdeMacBook-Pro:~$ <span class="token function">lsof</span> <span class="token parameter variable">-p</span> <span class="token variable">$$</span>
COMMAND   PID      <span class="token environment constant">USER</span>   FD   TYPE DEVICE SIZE/OFF                NODE NAME
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang  cwd    DIR    <span class="token number">1,4</span>     <span class="token number">1504</span>         <span class="token number">12884930381</span> /Users/chenshang
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang  txt    REG    <span class="token number">1,4</span>  <span class="token number">1296704</span> <span class="token number">1152921500312764811</span> /bin/bash
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang  txt    REG    <span class="token number">1,4</span>  <span class="token number">2547760</span> <span class="token number">1152921500312767057</span> /usr/lib/dyld
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang    0u   CHR   <span class="token number">16,4</span>    0t142                 <span class="token number">819</span> /dev/ttys004
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang    1u   CHR   <span class="token number">16,4</span>    0t142                 <span class="token number">819</span> /dev/ttys004
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang    2u   CHR   <span class="token number">16,4</span>    0t142                 <span class="token number">819</span> /dev/ttys004
<span class="token function">bash</span>    <span class="token number">25660</span> chenshang  255u   CHR   <span class="token number">16,4</span>    0t142                 <span class="token number">819</span> /dev/ttys004<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如上图,<code>lsof -p $$</code> 其中 <code>$$ </code>代表当前进程,这段指令的意思是输出当前进程的打开文件描述符都有哪些. 其中FD列代表文件表述负号。目前我们看到的只有上述几个，但是FD的类型非常多，不过我们并不是全部都需要关心和使用，我们只需要知道文件描述符其实是一个整数而已,这个整数如果在没有特殊配置的情况下默认最大是255，也就是说一个进程最多打开255个文件，一般是够用了，但是总有贪心的时候，我们可以用 <code>ulimit -n</code> 来设置进程打开的最大文件描述符的大小。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cwd</td>
<td>表示 current  work dirctory,即：应用程序的当前工作目录，这是该应用程序启动的目录，除非它本身对这个目录进行更改</td>
</tr>
<tr>
<td>txt</td>
<td>该类型的文件是程序代码，如应用程序二进制文件本身或共享库，如上列表中显示的 /sbin/init  程序</td>
</tr>
<tr>
<td>lnn</td>
<td>library references （AIX）</td>
</tr>
<tr>
<td>er</td>
<td>FD  information  error （see  NAME  column）</td>
</tr>
<tr>
<td>jld</td>
<td>jail  directory（FreeBSD）</td>
</tr>
<tr>
<td>ltx</td>
<td>shared  library text（code and  data）</td>
</tr>
<tr>
<td>mxx</td>
<td>hex  memory-mapped  type number  xx.</td>
</tr>
<tr>
<td>m86</td>
<td>DOS  Merge  mapped  file</td>
</tr>
<tr>
<td>mem</td>
<td>memory-mapped  file</td>
</tr>
<tr>
<td>mmap</td>
<td>memory-mapped device</td>
</tr>
<tr>
<td>pd</td>
<td>parent  directory</td>
</tr>
<tr>
<td>rtd</td>
<td>root  directory</td>
</tr>
<tr>
<td>tr</td>
<td>kernel  trace file （OpenBSD）</td>
</tr>
<tr>
<td>v86</td>
<td>VP/ix  mapped  file</td>
</tr>
<tr>
<td>0</td>
<td>表示标准输出</td>
</tr>
<tr>
<td>1</td>
<td>表示标准输入</td>
</tr>
<tr>
<td>2</td>
<td>表示标准错误</td>
</tr>
</tbody>
</table>
<p>我们现在先关心 0、1、2 这三个文件描述符</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>文件描述符</th>
<th>默认情况</th>
<th>对应文件句柄位置</th>
</tr>
</thead>
<tbody>
<tr>
<td>标准输入（standard input）</td>
<td>0</td>
<td>从键盘获得输入</td>
<td>/proc/self/fd/0</td>
</tr>
<tr>
<td>标准输出（standard output）</td>
<td>1</td>
<td>输出到屏幕(即控制台)</td>
<td>/proc/self/fd/1</td>
</tr>
<tr>
<td>错误输出（error output）</td>
<td>2</td>
<td>输出到屏幕（即控制台）</td>
<td>/proc/self/fd/2</td>
</tr>
</tbody>
</table>
<h2 id="输出重定向">输出重定向</h2>
<p>我们使用&gt;或者&gt;&gt;对输出进行重定向。符号的左边表示文件描述符，如果没有的话表示1，也就是标准输出，符号的右边可以是一个文件，也可以是一个输出设备。当使用&gt;时，会判断右边的文件存不存在，如果存在的话就先删除，然后创建一个新的文件，不存在的话则直接创建。但是当使用&gt;&gt;进行追加时，则不会删除原来已经存在的文件。语法如下所示:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">command1 <span class="token operator">&gt;</span> file1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="输入重定向">输入重定向</h2>
<p>我们使用&lt;对输入做重定向，如果符号左边没有写值，那么默认就是0。和输出重定向一样，Unix 命令也可以从文件获取输入，语法为：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">command1 &lt; file1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Here-Document">Here Document</h2>
<p>Here Document 是 Shell 中的一种特殊的重定向方式，用来将输入重定向到一个交互式 Shell 脚本或程序。<br>
它的基本的形式如下：</p>
<pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">command &lt;&lt; delimiter
    document
delimiter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>它的作用是将两个 delimiter 之间的内容(document) 作为输入传递给 command。</p>
<p>注意：<br>
结尾的delimiter 一定要顶格写，前面不能有任何字符，后面也不能有任何字符，包括空格和 tab 缩进。<br>
开始的delimiter前后的空格会被忽略掉。</p>
<h2 id="重定向绑定">重定向绑定</h2>
<p>好了，在有了以上知识的基础上，我们经常见到这样的写法 <code>&gt;/dev/null 2&gt;&amp;1</code>。这条命令其实分为两命令，一个是<code>&gt;/dev/null</code>，另一个是<code>2&gt;&amp;1</code>。</p>
<h4 id="dev-null"><code>&gt;/dev/null</code></h4>
<p>这条命令的作用是将标准输出1重定向到<code>/dev/null</code>中。<code>/dev/null</code>代表linux的空设备文件，所有往这个文件里面写入的内容都会丢失，俗称“黑洞”。那么执行了<code>&gt;/dev/null</code>之后，标准输出就会不再存在，没有任何地方能够找到输出的内容。</p>
<h4 id="2-1"><code>2&gt;&amp;1</code></h4>
<p>这条命令用到了重定向绑定，采用&amp;可以将两个输出绑定在一起。这条命令的作用是错误输出将和标准输出同用一个文件描述符，说人话就是错误输出将会和标准输出输出到同一个地方。</p>
<p>linux在执行shell命令之前，就会确定好所有的输入输出位置，并且从左到右依次执行重定向的命令，所以<code>&gt;/dev/null 2&gt;&amp;1</code>的作用就是让标准输出重定向到<code>/dev/null</code>中（丢弃标准输出），然后错误输出由于重用了标准输出的描述符，所以错误输出也被定向到了<code>/dev/null</code>中，错误输出同样也被丢弃了。执行了这条命令之后，该条shell命令将不会输出任何信息到控制台，也不会有任何信息输出到文件中。</p>
<p>这样的用法主要使用在我们想执行某条指令，而且也知道这条指令不会产生错误或者我们就根本不关心这条这令的执行结果的时候使用，例如我们先清空一下内存，然后在执行某某操作，我们清理内存的目的只是让程序执行的空间多一点，执行的速度快一点，至于是否真的释放了多少空间，我们是不关心，这时候就可以用这个命令。</p>
<p>在BaseShell中的实战应用<br>
在函数中既想打印日志,有不想影响函数的返回值,因为我么知道一个函数中的标准输出都将作为函数的返回值输出,即使是中间的日志结果。为此我们可以用到重定向来解决此问题.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">log_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${log_level}</span> <span class="token parameter variable">-ge</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\\">\\</span>033[37m[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%dT%H:%M:%S<span class="token variable">)</span></span>][<span class="token variable">$$</span> <span class="token variable">$BASHPID</span>] [INFO] [<span class="token variable">${FUNCNAME<span class="token punctuation">[</span>1<span class="token punctuation">]</span>}</span>]:    <span class="token variable">$*</span><span class="token entity" title="\\">\\</span>033[0m"</span><span class="token operator">|</span>trim <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token file-descriptor important">&amp;2</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%dT%H:%M:%S<span class="token variable">)</span></span>][<span class="token variable">$$</span> <span class="token variable">$BASHPID</span>] [INFO] [<span class="token variable">${FUNCNAME<span class="token punctuation">[</span>1<span class="token punctuation">]</span>}</span>]:    <span class="token variable">$*</span>"</span><span class="token operator">|</span>trim <span class="token operator">&gt;&gt;</span> <span class="token string">"<span class="token variable">${LOG_DIR}</span>/<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%d<span class="token variable">)</span></span>.info.log"</span>  <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%dT%H:%M:%S<span class="token variable">)</span></span>][<span class="token variable">$$</span> <span class="token variable">$BASHPID</span>] [INFO] [<span class="token variable">${FUNCNAME<span class="token punctuation">[</span>1<span class="token punctuation">]</span>}</span>]:    <span class="token variable">$*</span>"</span><span class="token operator">|</span>trim <span class="token operator">&gt;&gt;</span> <span class="token string">"<span class="token variable">${LOG_DIR}</span>/<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%d<span class="token variable">)</span></span>.log"</span>  <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
  <span class="token keyword">fi</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的 2&gt;&amp;1 会把所有的标准输出当成标准错误输出,标准错误是不会被认为函数的返回值的。</p>
<h1>二、进程间通信</h1>
<p>进程间通信，无外乎 管道、有名管道、共享存储、信号、信号量、消息队列、套接字 这几种，进程间通信从来都不能直接通信，必须找一个中间媒介。中间媒介就是上面说的几种，他们都要一个特点就是：一个进程的信息先存起来，然后另一个进程在读出来，这样就达到了进程间通信的目的。线程间通信也一样，我们学Java的多线程的时候简单很多，只有两种，想想线程间是怎么通信的：什么共享内存啊（就是搞个votail的共享变量，类似进程通信的共享存储）、什么wait、notify啊，Java叫通知机制（就是搞个信号，类似进程通信的信号）</p>
<h2 id="管道">管道</h2>
<p>管道是进程间通信的主要手段之一。一个管道实际上就是个只存在于内存中的文件，对这个文件的操作要通过两个已经打开文件进行，它们分别代表管道的两端。管道是一种特殊的文件，它不属于某一种文件系统，而是一种独立的文件系统，有其自己的数据结构。根据管道的适用范围将其分为：无名管道和命名管道。</p>
<h3 id="无名管道">无名管道</h3>
<p>主要用于父进程与子进程之间，或者两个兄弟进程之间。在linux系统中可以通过系统调用建立起一个单向的通信管道，且这种关系只能由父进程来建立。管道是将前一个命令的输出作为后一个命令的输入 <code>命令1 | 命令2 | 命令3 | ...</code></p>
<p>在BaseShell中的实战应用<br>
如何写一个命令,让他支持使用管道的形式接受参数呢。例如 我想计算某个字符串的 hashCode. 我期望的形式是 <code>echo " 123 "|hashCode</code> 然后就能得到结果。 而在计算 hashCode 之前，我还期望先trim一下。所以我更希望的写法是 <code>echo " 123 "|trim|hashCode</code>。我的BaseShell是如下实现的</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 这是一个辅助函数,意思是被其他函数调用的函数,以扩展原来函数的功能</span>
<span class="token comment"># 1. 有参数的时候直接走 _action 否则执行2</span>
<span class="token comment"># 2. 从标准输出中获取参数,并执行 _action</span>
<span class="token comment"># 该方法扩展原函数,使其具备从标准输出获取参数的能力,因此原函数可以类似管道似的调用.</span>
<span class="token comment"># @see BaseString.sh trim|string_length</span>
<span class="token comment"># @attention 从标准输入读取的参数是以空格分隔的 echo "1 2" "3 4"|trim 最终读取到的参数是 "1 2 3 4" 而不是 "1 2" 和 "3 4"</span>
<span class="token comment"># 适用于明确只有一个参数的情况</span>
<span class="token keyword">function</span> <span class="token function-name function">pip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">param</span><span class="token operator">=</span><span class="token variable">$*</span>
  <span class="token comment">#参数长度==0 尝试从标准输出获取参数</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${<span class="token operator">#</span>param}</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    <span class="token comment"># timeout 设置1秒的超时</span>
    <span class="token assign-left variable">param</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">timeout</span> <span class="token number">1</span> <span class="token function">cat</span> <span class="token operator">&lt;</span><span class="token file-descriptor important">&amp;0</span><span class="token variable">)</span></span>
  <span class="token keyword">fi</span>
  _action <span class="token string">"<span class="token variable">${param}</span>"</span>
<span class="token punctuation">}</span>

<span class="token comment"># 去掉字符串前后空格 [String]&lt;-(param:String)</span>
<span class="token keyword">function</span> <span class="token function-name function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">param</span><span class="token operator">=</span><span class="token variable">$*</span>
  <span class="token function-name function">_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">param</span><span class="token operator">=</span><span class="token variable">$*</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">${param}</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-o</span> <span class="token string">"[^ ]\+\( \+[^ ]\+\)*"</span>
  <span class="token punctuation">}</span>
  pip <span class="token string">"<span class="token variable">${param}</span>"</span>
<span class="token punctuation">}</span>

<span class="token comment"># 哈希code  [String]&lt;-(str:String)</span>
<span class="token keyword">function</span> <span class="token function-name function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">param</span><span class="token operator">=</span><span class="token variable">$1</span>
  <span class="token function-name function">_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">param</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">hash</span><span class="token operator">=</span><span class="token number">0</span>
    <span class="token builtin class-name">local</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>${#param}<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
      <span class="token builtin class-name">printf</span> <span class="token parameter variable">-v</span> val <span class="token string">"%d"</span> <span class="token string">"'<span class="token variable">${param<span class="token operator">:</span>$i<span class="token operator">:</span>1}</span>"</span> <span class="token comment"># val is ASCII val</span>
      <span class="token keyword">if</span> <span class="token variable"><span class="token punctuation">((</span><span class="token number">31</span> <span class="token operator">*</span> hash <span class="token operator">+</span> val <span class="token operator">&gt;</span> <span class="token number">2147483647</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token comment"># hash scheme</span>
        <span class="token assign-left variable">hash</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token operator">-</span> <span class="token number">2147483648</span> <span class="token operator">+</span> <span class="token punctuation">(</span> <span class="token number">31</span> <span class="token operator">*</span> hash <span class="token operator">+</span> val <span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2147483648</span><span class="token variable">))</span></span>
      <span class="token keyword">elif</span> <span class="token variable"><span class="token punctuation">((</span><span class="token number">31</span> <span class="token operator">*</span> hash <span class="token operator">+</span> val <span class="token operator">&lt;</span> <span class="token operator">-</span> <span class="token number">2147483648</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">hash</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">2147483648</span> <span class="token operator">-</span> <span class="token punctuation">(</span> <span class="token number">31</span> <span class="token operator">*</span> hash <span class="token operator">+</span> val <span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2147483648</span><span class="token variable">))</span></span>
      <span class="token keyword">else</span>
        <span class="token assign-left variable">hash</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">31</span> <span class="token operator">*</span> hash <span class="token operator">+</span> val<span class="token variable">))</span></span>
      <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    <span class="token builtin class-name">printf</span> <span class="token string">"%d"</span> <span class="token string">"<span class="token variable">${hash}</span>"</span> <span class="token comment"># final hashCode in decimal</span>
  <span class="token punctuation">}</span>
  pip <span class="token string">"<span class="token variable">${param}</span>"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我么可以看到 pip 函数，此外 BaseShell中还有实现 pip2 和 pip3 等既可以接收管道入参也可以接收直接入参</p>
<h3 id="有名管道">有名管道</h3>
<p>命名管道是建立在实际的磁盘介质或文件系统（而不是只存在于内存中）上有自己名字的文件，任何进程可以在任何时间通过文件名或路径名与该文件建立联系。为了实现命名管道，引入了一种新的文件类型——FIFO文件（遵循先进先出的原则）。实现一个命名管道实际上就是实现一个FIFO文件。命名管道一旦建立，之后它的读、写以及关闭操作都与普通管道完全相同。虽然FIFO文件的inode节点在磁盘上，但是仅是一个节点而已，文件的数据还是存在于内存缓冲页面中，和普通管道相同。管道可以想象成一个一端进入一端读取的队列,可以理解成一个先进先出的数据结构，通过 mkfifo 可以创建一个有名管道</p>
<p>我们执行 <code>mkfifo queue</code> 就可以创建一个有名管道,这个有名管道和上面的匿名管道一样,只不过匿名管道,么有名字,有名管道有名字而已。匿名管道主要应用与父子进程之间,而有名管道除了用在父子进程上之外,还可以用在兄弟进程之间。有名管道的特点就是,一端写入,如果另一端么有人读取的话,那么写入端阻塞。同理，如果一段读取，另一端写入，如果没有写入，那么读取端就会阻塞。利用这个特性我们可以用于控制进程并行的数量，模拟多线程控制。</p>
<p>在BaseShell中的实战应用<br>
并发工具包 Concurrent 中的实现</p>
<h3 id="管道实现机制">管道实现机制</h3>
<p>管道是由内核管理的一个缓冲区，相当于我们放入内存中的一个纸条。管道的一端连接一个进程的输出。这个进程会向管道中放入信息。管道的另一端连接一个进程的输入，这个进程取出被放入管道的信息。一个缓冲区不需要很大一般为4K大小，它被设计成为环形的数据结构，以便管道可以被循环利用。当管道中没有信息的话，从管道中读取的进程会等待，直到另一端的进程放入信息。当管道被放满信息的时候，尝试放入信息的进程会等待，直到另一端的进程取出信息。当两个进程都终结的时候，管道也自动消失。</p>
<h2 id="信号">信号</h2>
<p>信号是另一种进程间通信机制，它给应用程序提供一种异步的软件中断，使应用程序有机会接受其他程序活终端发送的命令(即信号)。应用程序收到信号后，有三种处理方式：忽略，默认，或捕捉。进程收到一个信号后，会检查对该信号的处理机制。如果是SIG_IGN，就忽略该信号；如果是SIG_DFT，则会采用系统默认的处理动作，通常是终止进程或忽略该信号；如果给该信号指定了一个处理函数(捕捉)，则会中断当前进程正在执行的任务，转而去执行该信号的处理函数，返回后再继续执行被中断的任务。</p>
<p>在有些情况下，我们不希望自己的shell脚本在运行时刻被中断，比如说我们写得shell脚本设为某一用户的默认shell，使这一用户进入系统后只能作某一项工作，如数据库备份， 我们可不希望用户使用 Ctrl+C 等方法进入到shell状态做我们不希望做的事情。这便用到了信号处理。</p>
<p>以下是一些你可能会遇到的常见信号：</p>
<table>
<thead>
<tr>
<th>信号名称</th>
<th>信号数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIGHUP</td>
<td>1</td>
<td>本信号在用户终端连接（正常或非正常）结束时发出，通常是在终端的控制进程结束时，通知同一session内的各个作业，这时它们与控制终端不再关联。登录Linux时，系统会分配给登录用户一个终端(Session)。在这个终端运行的所有程序，包括前台进程组和后台进程组，一般都属于这个Session。当用户退出Linux登录时，前台进程组和后台有对终端输出的进程将会收到SIGHUP信号。这个信号的默认操作为终止进程，因此前台进程组和后台有终端输出的进程就会中止。对于与终端脱离关系的守护进程，这个信号用于通知它重新读取配置文件。</td>
</tr>
<tr>
<td>SIGINT</td>
<td>2</td>
<td>程序终止(interrupt)信号，在用户键入 Ctrl+C 时发出。</td>
</tr>
<tr>
<td>SIGQUIT</td>
<td>3</td>
<td>和SIGINT类似，但由QUIT字符(通常是Ctrl /)来控制。进程在因收到SIGQUIT退出时会产生core文件，在这个意义上类似于一个程序错误信号。</td>
</tr>
<tr>
<td>SIGFPE</td>
<td>8</td>
<td>在发生致命的算术运算错误时发出。不仅包括浮点运算错误，还包括溢出及除数为0等其它所有的算术错误。</td>
</tr>
<tr>
<td>SIGKILL</td>
<td>9</td>
<td>用来立即结束程序的运行。本信号不能被阻塞，处理和忽略。</td>
</tr>
<tr>
<td>SIGALRM</td>
<td>14</td>
<td>时钟定时信号，计算的是实际的时间或时钟时间。alarm 函数使用该信号。</td>
</tr>
<tr>
<td>SIGTERM</td>
<td>15</td>
<td>程序结束(terminate)信号, 与SIGKILL不同的是该信号可以被阻塞和处理. 通常用来要求程序自己正常退出；kill 命令缺省产生这个信号。</td>
</tr>
</tbody>
</table>
<p>那怎么用呢? 我们如何实现我们脚本在行过程当中，当我们主动按下 <code>Ctrl+C</code>的时候主动终止呢？</p>
<p>加入下面一行就可以了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">trap</span> <span class="token string">"echo 'exit...';exit"</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>意思就是说 捕捉信号2 然后执行 <code>echo 'exit...';exit</code>。</p>
<p>我们可以学习一下trap这个指令。等我出教程。</p>
<h1>三、copy on write</h1>
<p>大家都知道 redis 的写时复制技术，我们看看Linux是怎么做的。在Linux程序中，fork（）会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，出于效率考虑，linux中引入了“写时复制“技术，也就是只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。当我在父进程中开启一个子进程的时候，同样会复制一份父进程的文件描述符，只有当子进程改变文件描述符的内容时候，这个文件描述符才会分裂，所以redis的写时复制技术其实就是依赖的Linux本身就自带的机制。这跟我们多线程中的理解是不同的，因此也会造成一些误会，Java中多线程对共享变量的修改是可见的，但是在Shell的多进程里面则是相反的,你在子进程对父进程变量所做的修改是无论如何也不可的。我们来证明一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">10</span> <span class="token comment"># 先定义一个变量</span>
<span class="token function-name function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"父进程:<span class="token variable">${a}</span>"</span>
  <span class="token punctuation">(</span>
    <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">100</span>
    <span class="token keyword">while</span> <span class="token builtin class-name">:</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"子进程:<span class="token variable">${a}</span>"</span>
       <span class="token function">sleep</span> <span class="token number">2</span>
    <span class="token keyword">done</span>
  <span class="token punctuation">)</span> <span class="token operator">&amp;</span>  <span class="token comment">#通过 () 便可开启一个子进程 ，在这个子进程里，我们改变变量a的值，然后不停的输出变量a的值</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"父进程:<span class="token variable">${a}</span>"</span> <span class="token comment">#我们在父进程中打印一下，发现根本没有变</span>
  <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">1000</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"父进程:<span class="token variable">${a}</span>"</span> <span class="token comment">#我们在父进程中改变一下变量的值,发现子进程输出也不会改变</span>
  <span class="token function">wait</span>
<span class="token punctuation">}</span>
f1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>四、并发控制</h1>
<h2 id="令牌控制">令牌控制</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 注意这个方法是阻塞方法</span>
<span class="token comment"># 提交一个任务 []&lt;-(task:Function)</span>
<span class="token keyword">function</span> <span class="token function-name function">threadPool_submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> _NotBlank <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token string">"thread pool can not be null"</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">fd</span><span class="token operator">=</span><span class="token variable">$1</span> <span class="token punctuation">;</span><span class="token builtin class-name">shift</span> <span class="token punctuation">;</span><span class="token builtin class-name">local</span> <span class="token assign-left variable">task</span><span class="token operator">=</span><span class="token variable">$*</span>
  <span class="token comment">#获取执行令牌,获取不到令牌则阻塞,直到有任务结束执行归还令牌</span>
  <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-u</span> <span class="token string">"<span class="token variable">${fd}</span>"</span> token
  <span class="token punctuation">{</span>
    <span class="token builtin class-name">eval</span> <span class="token string">"<span class="token variable">${task}</span>"</span> <span class="token comment">#开始执行耗时操作</span>
    <span class="token builtin class-name">eval</span> <span class="token string">"echo <span class="token variable">${token}</span> &gt;&amp; <span class="token variable">${fd}</span>"</span> <span class="token comment">#归还令牌</span>
  <span class="token punctuation">}</span> <span class="token operator">&amp;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="队列控制">队列控制</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># coreSize:核心线程数</span>
<span class="token comment"># keepAliveTime:线程的存活时间</span>
<span class="token comment"># 任务队列使用的是无限的任务队列</span>
<span class="token comment"># eg: new_ThreadPoolExecutor &amp;&amp; local pool=$?</span>
<span class="token comment"># 新建线程池 [int]&lt;-(coreSize:Integer,keepAliveTime:Long)</span>
<span class="token keyword">function</span> <span class="token function-name function">new_ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> _NotBlank <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token string">"core size can not be null"</span> <span class="token operator">&amp;&amp;</span> _Natural <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> _Min <span class="token string">"0"</span> <span class="token string">"<span class="token variable">$1</span>"</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">coreSize</span><span class="token operator">=</span><span class="token variable">$1</span> <span class="token comment">#核心线程数</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">keepAliveTime</span><span class="token operator">=</span><span class="token variable">${2<span class="token operator">:-</span>1}</span> <span class="token comment">#线程的存活时间</span>

  <span class="token builtin class-name">local</span> <span class="token assign-left variable">lock</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>new_fd<span class="token variable">)</span></span>
  new_lock <span class="token string">"<span class="token variable">${lock}</span>"</span>

  <span class="token builtin class-name">local</span> <span class="token assign-left variable">fd</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>new_fd<span class="token variable">)</span></span>
  new_fifo <span class="token string">"<span class="token variable">${fd}</span>"</span>

  <span class="token keyword">for</span><span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>coreSize<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token builtin class-name">:</span><span class="token punctuation">;</span><span class="token keyword">do</span>
        <span class="token builtin class-name">trap</span> <span class="token string">'echo you hit Ctrl-C/Ctrl-\, now exiting.....; exit'</span> SIGINT SIGQUIT
        lock_tryLock <span class="token string">"<span class="token variable">${lock}</span>"</span> <span class="token comment">#这个地方必须加锁,防止read并发读导致task错乱</span>
        <span class="token builtin class-name">read</span> <span class="token parameter variable">-t</span> <span class="token string">"<span class="token variable">${keepAliveTime}</span>"</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-u</span> <span class="token string">"<span class="token variable">${fd}</span>"</span> task
        lock_unLock <span class="token string">"<span class="token variable">${lock}</span>"</span>
        isBlank <span class="token string">"<span class="token variable">${task}</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span>
        <span class="token builtin class-name">eval</span> <span class="token string">"<span class="token variable">${task}</span>"</span>
      <span class="token keyword">done</span>
    <span class="token punctuation">}</span> <span class="token operator">&amp;</span>
  <span class="token keyword">done</span>

  <span class="token builtin class-name">return</span> <span class="token string">"<span class="token variable">${fd}</span>"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>五、调试技巧</h1>
<ol>
<li>使用 set -x 可以打印出脚本执行的中间结果</li>
<li>使用 bashdb 工具可以控制脚本一步一步执行</li>
<li>使用 Idea 的bashsuport插件【推荐】</li>
</ol>
<h1>六、锁</h1>
<p>在 Linux 中的两条进程同时编辑文件产生并发冲突时, 我们第一反应就会想到使用 锁 来解决这个问题, 这里就介绍 flock。</p>
<h2 id="flock">flock</h2>
<p>flock 有三种写法 :</p>
<ol>
<li>flock [options] | […]</li>
<li>flock [options] | -c</li>
<li>flock [options] &lt;file descriptor number(fd)&gt;</li>
</ol>
<h3 id="将锁加在文件上以防止冲突">将锁加在文件上以防止冲突</h3>
<p>flock 可以将锁加在某个文件上 (以及文件夹), 来防止并发冲突, 其中一个用途就是用在定时任务中。例如每分钟执行一次检查任务，如果agent没有启动则启动agent.如果第一个任务还没有结束，然后又启动了一个检查任务，最后可能启动多个agent实例。所以我们需要再检查的时候如果agent没有启动才启动，如果检查任务还没有结束我们就不开启下一个检查任务。当然我们的实现方式有很多中。如下使用flock是一种，flock可以保证一个进程在启动的时候在某个文件上加上一把锁，可以是排它锁，其他进程如果先要获取这个锁必须等上一个进程结束才行。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">echo</span> <span class="token string">"* * * * * cd <span class="token variable">${coreDir}</span>; /usr/bin/flock -xn /tmp/checkAndFixAgent.lock -c '/bin/bash core.sh checkAndFixAgent &gt; /dev/null 2&gt;&amp;1'"</span>

<span class="token comment">#检查并修复agent</span>
<span class="token function-name function">checkAndFixAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">success</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>checkAgent<span class="token variable">)</span></span>
  isFalse <span class="token string">"<span class="token variable">${success}</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
    <span class="token function">mount</span> <span class="token parameter variable">-o</span> rw,remount /
    startAgent
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然flock也有他的弊端，这个我们很少遇到，我目前还没有理解，等我真实遇到在补充。</p>
<h3 id="将锁加在-文件描述符-fd-上">将锁加在 文件描述符 (fd) 上</h3>
<p>flock 也可以对某个 fd 加锁, 这种通常用于一个进程的子进程中. 关于 fd, 由于 Linux 一切皆文件的哲学, 所以我们常用的 stdout 就是 fd 1, stderr 就是 fd 2, 我们也可以自定义 fd</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取一个可用的文件描述符号</span>
<span class="token keyword">function</span> <span class="token function-name function">new_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token punctuation">{</span>
    flock <span class="token number">3</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">find</span><span class="token operator">=</span><span class="token variable">${NULL}</span>
    <span class="token keyword">for</span><span class="token variable"><span class="token punctuation">((</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>fd<span class="token operator">&lt;</span><span class="token number">1024</span><span class="token punctuation">;</span>fd<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span><span class="token keyword">do</span>
      <span class="token builtin class-name">local</span> <span class="token assign-left variable">rco</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token boolean">true</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">&gt;&amp;</span> $<span class="token punctuation">{</span>fd<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> $?<span class="token variable">)</span></span>"</span>
      <span class="token builtin class-name">local</span> <span class="token assign-left variable">rci</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token boolean">true</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">&lt;&amp;</span> $<span class="token punctuation">{</span>fd<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> $?<span class="token variable">)</span></span>"</span>
      <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">${rco}</span><span class="token variable">${rci}</span>"</span> <span class="token operator">==</span> <span class="token string">"11"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">find</span><span class="token operator">=</span><span class="token variable">${fd}</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">break</span>
    <span class="token keyword">done</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">${find}</span>"</span>
  <span class="token punctuation">}</span> <span class="token operator"><span class="token file-descriptor important">3</span>&lt;&gt;</span>/tmp/base_shell.lock
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样我们就可以避免两个进程同时对一个文件的读写而产生错误了.</p>
<h3 id="附录">附录</h3>
<table>
<thead>
<tr>
<th>Options</th>
<th>-</th>
<th>-</th>
</tr>
</thead>
<tbody>
<tr>
<td>-s</td>
<td>–shared</td>
<td>共享锁</td>
</tr>
<tr>
<td>-x</td>
<td>–exclusive</td>
<td>独占锁，默认类型</td>
</tr>
<tr>
<td>-u</td>
<td>–unlock</td>
<td>解锁, (通常不需要手动解锁, 默认 -c 后的命令退出时, FD 会关闭, 会将文件解锁)</td>
</tr>
<tr>
<td>-n</td>
<td>–nonblock</td>
<td>非阻塞，若指定的文件正在被其他进程锁定，则立即以失败 (1) 返回</td>
</tr>
<tr>
<td>-w</td>
<td>–timeout</td>
<td>若指定的文件正在被其他进程锁定，则等待指定的秒数；指定为 0 将被视为非阻塞</td>
</tr>
<tr>
<td>-o</td>
<td>–close</td>
<td>锁定文件后与执行命令前，关闭用于引用加锁文件的文件描述符</td>
</tr>
<tr>
<td>-E</td>
<td>–conflict-exit-code</td>
<td>若指定 - n 时请求加锁的文件正在被其他进程锁定，或指定 - w 时等待超时，则以该选项的参数作为返回值</td>
</tr>
<tr>
<td>-F</td>
<td>–no-fork</td>
<td>不 fork 执行命令</td>
</tr>
<tr>
<td>-c</td>
<td>–command</td>
<td>运行的命令</td>
</tr>
</tbody>
</table>
<h2 id="自定义锁">自定义锁</h2>
<p>参考 BaseShell 框架 BaseLock 部分</p>
<h1>七、函数编程</h1>
<p>Shell 可以像 函数语言一样，将函数作为参数进行传递的。</p>
<p>我们现在想要在执行函数前打印一个时间,执行函数后打印一个时间,然后统计这个函数的执行时长。类似于切面，我们看看用Shell可以怎么实现</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function-name function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"你正在执行add操作 ing"</span>
  <span class="token function">sleep</span> <span class="token number">5</span>
<span class="token punctuation">}</span>

<span class="token function-name function">sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"你正在执行sub操作 ing"</span>
  <span class="token function">sleep</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token function-name function">aop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">function</span><span class="token operator">=</span><span class="token variable">$1</span>

  <span class="token builtin class-name">local</span> <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span>
  <span class="token builtin class-name">echo</span> <span class="token string">"开始执行<span class="token variable">${function}</span>前：<span class="token variable">$start</span>"</span>

  <span class="token builtin class-name">eval</span> <span class="token string">"<span class="token variable">${function}</span>"</span>

  <span class="token builtin class-name">local</span> <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span>
  <span class="token builtin class-name">echo</span> <span class="token string">"执行<span class="token variable">${function}</span>后：<span class="token variable">$end</span>,耗时L:<span class="token variable"><span class="token variable">$((</span>end<span class="token operator">-</span>start<span class="token variable">))</span></span>s"</span>
<span class="token punctuation">}</span>

<span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  aop <span class="token string">"add"</span> <span class="token operator">&amp;</span>
  aop <span class="token string">"sub"</span> <span class="token operator">&amp;</span>
  <span class="token function">wait</span>
<span class="token punctuation">}</span>

main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>八、import 其他脚本</h1>
<p>使用 <code>source</code> 或 <code>.</code><br>
例如: <code>source ./../../BaseShell/Starter/BaseHeader.sh</code> 就可以引入 <a target="_blank" rel="noopener" href="http://BaseHeader.sh">BaseHeader.sh</a> 中定义的各种函数和变量<br>
如何解决 A.sh-&gt;<a target="_blank" rel="noopener" href="http://B.sh">B.sh</a> 然后 B.sh-&gt;<a target="_blank" rel="noopener" href="http://A.sh">A.sh</a> 这样循环引用的尴尬境地的,因为这样就死循环了,会撑爆进程栈的。编译行语言Java是很好解决这个问题的,因为他是编译型,编译的过程是不执行程序的,用的方法叫双亲委派原则。单Shell不一样，我用的是下面这样的方法，基本解决思路是，在脚本执行实现先检查一下当前脚本是否已经加载过，加载过就直接return.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#===============================================================</span>
<span class="token assign-left variable">import</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">"<span class="token variable">${<span class="token environment constant">BASH_SOURCE</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span>}</span>"</span> .sh<span class="token variable">)</span></span>_<span class="token variable">$$</span>"</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">'$'</span><span class="token string">"<span class="token variable">${import}</span>"</span><span class="token variable">)</span></span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token builtin class-name">return</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>
<span class="token builtin class-name">eval</span> <span class="token string">"<span class="token variable">${import}</span>=0"</span>
<span class="token comment">#===============================================================</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在脚本的开头只要加上上面的代码，就可以解决循环引用的问题。这是目前我想到的比较简单的方式,不排除以后还有新的方式,敬请期待,例如可以多线程并行检查等优化手段,先卖个关子,目前还没有想好。</p>
<h1>九、单元测试</h1>
<p>有人认为单元测试什么的不重要，这你就大错特错了，如果只是自己写几个脚本用，那没关系，因为不会影响别人。但如果要是像我一样提供一些脚本给大家用，那就需要单元测试了。因为脚本的移植性本来就很差，稍稍改动一点就坑很多，如果没有单元测试保障，回头改动某个函数过后导致大家使用出现问题，那就是不负责任了。</p>
<p>参考 <a target="_blank" rel="noopener" href="http://localhost:4000/2019/08/28/ji-zhu-zong-jie/baseshell/baseshell-shi-yong-jiao-cheng/">BaseShell使用教程</a> 中的 测试【Utils】章节</p>
<h1>十、动态创建函数</h1>
<p>我们可以动态的创建函数。应用如下面的例子我们可以替换一个函数的名字为另一函数，这样做我们可以实现类似的面向对象编程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重命名函数</span>
<span class="token keyword">function</span> <span class="token function-name function">new_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> _NotBlank <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token string">"source function name can not be null"</span> <span class="token operator">&amp;&amp;</span> _NotBlank <span class="token string">"<span class="token variable">$2</span>"</span> <span class="token string">"target function name can not be null"</span>
  <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">declare</span> <span class="token parameter variable">-f</span> $1<span class="token variable">)</span></span>"</span> <span class="token operator">||</span> <span class="token builtin class-name">return</span>
  <span class="token builtin class-name">eval</span> <span class="token string">"<span class="token variable">${_<span class="token operator">/</span>$1<span class="token operator">/</span>$2}</span>"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>例如 <a target="_blank" rel="noopener" href="http://BaseArrayList.sh">BaseArrayList.sh</a> 中的实现</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 这里会新建一个List,建议用在多线程模式下</span>
  new_arrayList number <span class="token comment">#创建一个名为number的List</span>
  number_add <span class="token number">1</span>         <span class="token comment">#向个number中添加一个元素</span>
  number_add <span class="token number">2</span>         <span class="token comment">#向个number中添加一个元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1>十一、递归</h1>
<h1>十二、设计模式</h1>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%8E%9F%E5%88%9B/">
                                    <span class="chip bg-color">原创</span>
                                </a>
                            
                                <a href="/tags/%E6%9C%AA%E5%AE%8C%E5%BE%85%E7%BB%AD/">
                                    <span class="chip bg-color">未完待续</span>
                                </a>
                            
                                <a href="/tags/Linux/">
                                    <span class="chip bg-color">Linux</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'zpykYxqrLC4qVar5tL3t0MAL-gzGzoHsz',
        appKey: '3LhmIMSf9HYX5VXhD21hiPPG',
        serverURLs: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/07/07/java/java-she-ji-mo-shi/chong-xie-she-ji-mo-shi-dan-li-mo-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="重写设计模式-单例模式">
                        
                        <span class="card-title">重写设计模式-单例模式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            教你三步写出单例模式
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            <a href="/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-category">
                                    Java设计模式
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E5%88%9B/">
                        <span class="chip bg-color">原创</span>
                    </a>
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/05/25/java/jvm-la-ji-hui-shou/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Jvm垃圾回收">
                        
                        <span class="card-title">Jvm垃圾回收</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            单说垃圾回收,这里涉及三个问题,哪些区域的垃圾需要回收,这些区域的垃圾如何识别,这些区域的垃圾如何回收。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-05-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E5%88%9B/">
                        <span class="chip bg-color">原创</span>
                    </a>
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('300')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 涓涓细流<br />'
            + '文章作者: 陈尚<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">陈尚</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">111.7k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/chen-shang" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2414973330@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2414973330" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2414973330" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
	<span id="jinrishici-sentence"></span>
        <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    
        <!-- <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script> -->
        <script src='/libs/mermaid/mermaid.min.js'></script>
        <script>
          if (window.mermaid) {
            mermaid.initialize({theme: 'forest'});
          }
        </script>
    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?f34c6ca18e751cd090a8864b66dda7fd";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>

</html>
